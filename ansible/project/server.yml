---
- hosts: "{{ host | default('web') }}"
  become: yes
  gather_facts: no
  pre_tasks:
    - name: Check and install python
      raw: |
        (/usr/bin/env python3 -V || /usr/bin/env python -V || /usr/bin/env python2 -V) || \
        (yum install -y python3 || yum install -y python) || \
        (apt install -y --no-install-recommends python3 || apt install -y --no-install-recommends python) || \
        (apk add --no-cache python3 || apk add --no-cache python2) || \
        (yum makecache -y && (yum install -y python3 || yum install -y python)) || \
        (apt update -y && (apt install -y --no-install-recommends python3 || apt install -y --no-install-recommends python)) || \
        (apk update && (apk add --no-cache python3 || apk add --no-cache python2))
    - name: Check and install bash
      raw: |
        /usr/bin/env bash --version || \
        (yum install -y bash || (yum makecache -y && yum install -y bash)) || \
        (apt install -y --no-install-recommends bash || (apt update -y && apt install -y --no-install-recommends bash)) || \
        (apk add --no-cache bash || (apk update && apk add --no-cache bash))
    - name: Check and install sudo
      raw: |
        /usr/bin/env sudo -V || \
        (yum install -y sudo || (yum makecache -y && yum install -y sudo)) || \
        (apt install -y --no-install-recommends sudo || (apt update -y && apt install -y --no-install-recommends sudo)) || \
        (apk add --no-cache sudo || (apk update && apk add --no-cache sudo));
        exit 0
  roles:
    - role: server_init
    - role: services_prepare
      when: prepare_services is defined and prepare_services
    - role: scripts_sync
      when: sync_scripts is defined and sync_scripts
    - role: iptables_get
    - role: get_facts
