---
# - name: Prepare binary locally
#   hosts: 127.0.0.1
#   connection: local
#   gather_facts: no
#   roles:
#     - role: gost_download
#       when: update_gost is defined and update_gost

- hosts: "{{ host | default('web') }}"
  become: yes
  gather_facts: yes
  pre_tasks:
    - name: get service facts
      service_facts:
      register: services
  roles:
    - role: services_prepare
      when: prepare_services is defined and prepare_services
    - role: scripts_sync
      when: sync_scripts is defined and sync_scripts
    - role: iptables_init
      when: init_iptables is defined and init_iptables
    - iptables_get
    - name: Get gost version
      role: app_get
      vars:
        app_name: gost
        app_version_arg: "-V"
    - name: Get v2ray version
      role: app_get
      vars:
        app_name: v2ray
        app_version_arg: "-version"
    - name: Get brook version
      role: app_get
      vars:
        app_name: brook
        app_version_arg: "-v"
    - name: Get socat version
      role: app_get
      vars:
        app_name: socat
        app_version_arg: "-V"
    - name: Get ehco version
      role: app_get
      vars:
        app_name: ehco
        app_version_arg: "-v"
    - name: Get wstunnel version
      role: app_get
      vars:
        app_name: wstunnel
        app_version_arg: "-V"
    - name: Get shadowsocks version
      role: shadowsocks_get
    - name: Get node_exporter version
      role: app_get
      vars:
        app_name: node_exporter
        app_version_arg: "--version"
    - name: Get tiny_port_mapper version
      role: app_get
      vars:
        app_name: tiny_port_mapper
        app_version_arg: "--h"
